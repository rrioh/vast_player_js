!function(){"use strict";function e(e,t,r){if(!t)return;let n=document.createElement("img");t=r(t,null),n.src=t,n.style.display="none",e.prepend(n),console.log("[DEBUG] beacon sent: "+t)}function t(t,r,n){if(t)for(let o of t)o=o.replace(/\[ERRORCODE\]/,r.toString()),e(document.body,o,n)}function r(t,r,n){!function(t,r,n){for(let o of r)t.addEventListener("canplay",(function(r){e(t,o,n)}),{once:!0})}(t,r.impressionUrls,n),function(e,t){for(let r of t.creatives)if(r.linear.clickThrough){const t=r.linear.clickThrough.content;e.addEventListener("click",(function(e){open(t,"_blank")}))}}(t,r),function(t,r,n){for(let o of r.creatives)for(let r of o.linear.clickTrackings){const o=r.content;t.addEventListener("click",(function(r){e(t,o,n)}))}}(t,r,n),function(t,r,n){t.addEventListener("loadedmetadata",(function(o){for(let o of r.creatives)for(let[r,i]of o.linear.trackingEvents)"loaded"==r?t.addEventListener("canplay",(function(r){e(t,i,n)}),{once:!0}):"pause"===r?t.addEventListener("pause",(function(r){t.currentTime<t.duration&&e(t,i,n)})):"number"==typeof r&&t.addEventListener("timeupdate",(function o(a){t.currentTime>=r&&(e(t,i,n),t.removeEventListener("timeupdate",o))}))}))}(t,r,n)}function n(e){let t=e.match(/(\d{2}):(\d{2}):(\d{2})\.?(\d{3})?/);if(!t||t.length<4||isNaN(parseInt(t[1]))||isNaN(parseInt(t[2]))||isNaN(parseInt(t[3])))throw new Error("convertdurationToSecond error: "+e);return 5!=t.length||isNaN(parseInt(t[4]))?60*parseInt(t[1])*60+60*parseInt(t[2])+parseFloat(t[3]):60*parseInt(t[1])*60+60*parseInt(t[2])+parseFloat(t[3]+"."+t[4])}function o(e){let t=[];for(let r of e){let e=r,o=parseInt(e.getAttribute("width")||"10")||10,i=parseInt(e.getAttribute("height")||"10")||10,a="0px",s=e.getAttribute("xPosition");s&&(a="left"===s||"right"===s?s:s+"px");let c="0px",l=e.getAttribute("yPosition");l&&(c="top"===l||"bottom"===l?l:l+"px");let p=e.getAttribute("offset"),d=0;p&&(d=n(p));let u=e.getAttribute("duration"),f=null;u&&(f=n(u)+d);const T=e.querySelector(":scope>StaticResource");if(!T||!T.textContent)continue;const h=e.querySelector(":scope>IconClicks>IconClickThrough"),m=e.querySelector(":scope>IconClicks>IconClickTracking");t.push({width:o,height:i,xPosition:a,yPosition:c,start:d,end:f,imgUrl:T.textContent,clickThroughUrl:h?.textContent??null,clickTrackingUrl:m?.textContent??null})}return t}var i;function a(e){let t=new Map;t.set("[TIMESTAMP]",(()=>(new Date).toISOString()));const r={ratio:0};return new IntersectionObserver((function(e){e.forEach((function(e){const t=Math.floor(100*e.intersectionRatio)/100;r.ratio=t}))}),{rootMargin:"0px",threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]}).observe(e),t.set("[INVIEW_RATIO]",function(e){return()=>e.ratio.toFixed(2)}(r)),(e,r)=>(r&&t.set("[ERRORCODE]",r.toString()),t.forEach(((t,r)=>{e=e.replace(r,"function"==typeof t?t():t)})),e)}!function(e){e[e.XMLParseError=100]="XMLParseError",e[e.VASTSchemaValidationError=101]="VASTSchemaValidationError",e[e.VASTVersionOfResponseNotSupported=102]="VASTVersionOfResponseNotSupported",e[e.NonPlayableAdType=200]="NonPlayableAdType",e[e.MediaPlayerExpectingDifferentLinearity=201]="MediaPlayerExpectingDifferentLinearity",e[e.MediaPlayerExpectingDifferentDuration=202]="MediaPlayerExpectingDifferentDuration",e[e.MediaPlayerExpectingDifferentSize=203]="MediaPlayerExpectingDifferentSize",e[e.AdCategoryNotProvided=204]="AdCategoryNotProvided",e[e.InlineCategoryViolatesWrapperBlockedAdCategories=205]="InlineCategoryViolatesWrapperBlockedAdCategories",e[e.AdNotServed=206]="AdNotServed",e[e.GeneralWrapperError=300]="GeneralWrapperError",e[e.VASTURIUnavailableOrTimeout=301]="VASTURIUnavailableOrTimeout",e[e.WrapperLimitReached=302]="WrapperLimitReached",e[e.NoVASTResponseAfterWrapper=303]="NoVASTResponseAfterWrapper",e[e.AdUnitNotDisplayed=304]="AdUnitNotDisplayed",e[e.GeneralLinearError=400]="GeneralLinearError",e[e.FileNotFound=401]="FileNotFound",e[e.MediaFileURITimeout=402]="MediaFileURITimeout",e[e.SupportedMediaFileNotFound=403]="SupportedMediaFileNotFound",e[e.ProblemDisplayingMediaFile=405]="ProblemDisplayingMediaFile",e[e.MezzanineNotProvided=406]="MezzanineNotProvided",e[e.MezzanineDownloading=407]="MezzanineDownloading",e[e.ConditionalAdRejected=408]="ConditionalAdRejected",e[e.InteractiveUnitNotExecuted=409]="InteractiveUnitNotExecuted",e[e.VerificationUnitNotExecuted=410]="VerificationUnitNotExecuted",e[e.NotRequiredSpecificationOfMezzanine=411]="NotRequiredSpecificationOfMezzanine",e[e.GeneralNonLinearAdsError=500]="GeneralNonLinearAdsError",e[e.NonLinearAdNonDisplayable=501]="NonLinearAdNonDisplayable",e[e.UnableToFetchNonLinearResource=502]="UnableToFetchNonLinearResource",e[e.SupportedNonLinearResourceNotFound=503]="SupportedNonLinearResourceNotFound",e[e.GeneralCompanionAdsError=600]="GeneralCompanionAdsError",e[e.CompanionNonDisplayableByDimemsionError=601]="CompanionNonDisplayableByDimemsionError",e[e.RequiredCompanionNonDisplayable=602]="RequiredCompanionNonDisplayable",e[e.UnableToFetchNonCompanionResource=603]="UnableToFetchNonCompanionResource",e[e.SupportedCompanionResourceNotFound=604]="SupportedCompanionResourceNotFound",e[e.UndefinedError=900]="UndefinedError",e[e.GeneralVPAIDError=901]="GeneralVPAIDError",e[e.GeneralInteractiveCreativeFileError=902]="GeneralInteractiveCreativeFileError"}(i||(i={}));const s=new Map([["start",0],["firstQuartile",1/4],["midpoint",.5],["thirdQuartile",3/4],["complete",1]]);const c=new class{constructor(){}isWrapper(e){return!!e.querySelector(":scope>Ad>Wrapper")}async nextVast(e){const t=e.querySelector(":scope>Ad>Wrapper>VASTAdTagURI");if(!t||!t.textContent)throw new Error("next vast url error");let r=t.textContent;const n=await fetch(r);return await n.text()}async parseVast(e,t){try{let r={errorUrls:[],impressionUrls:[],adTitle:"",adDesc:"",creatives:[]};for(let n=1;n<=5;n++){let o=this.parseVastXML(e);if(!this.isWrapper(o)){r=this.updateInlineVastObject(r,o,t);break}if(5==n)throw new Error("too many wrapper");r=this.updateWrapperVastObject(r,o,t),e=await this.nextVast(o)}return r}catch(e){return console.log("[ERROR] cannot create VASTObject: "+e),null}}parseVastXML(e){let t=(new DOMParser).parseFromString(e,"application/xml"),r=t.querySelector("parsererror");if(r)throw new Error(r.textContent||"parse vast error");let n=t.querySelector("VAST");if(!n)throw new Error("VAST tag not found");return n}updateWrapperVastObject(e,r,a){let s=[];const c=r.querySelector(":scope>Error");c&&c.textContent&&s.push(c.textContent);const l=r.querySelector(":scope>Ad>Wrapper");if(!l)throw t(s,i.NoVASTResponseAfterWrapper,a),new Error("parse Wrapper error");const p=l.querySelector(":scope>Error");p&&p.textContent&&s.push(p.textContent);const d=l.querySelector(":scope>Impression");if(!d||!d.textContent)throw t(s,i.XMLParseError,a),new Error("parse Wrapper Impression error");const u=d.textContent,f=l.querySelector(":scope>Creatives>Creative>Linear");if(!f)return e.errorUrls=e.errorUrls.concat(s),e.impressionUrls.push(u),e;const T=f.querySelector(":scope>Duration");if(!T||!T.textContent)throw t(s,i.XMLParseError,a),new Error("parse Wrapper Linear Duration error");const h=n(T.textContent),m=f.querySelectorAll(":scope>TrackingEvents>Tracking"),E=this.createTrackingObject(m,h),g=o(f.querySelectorAll(":scope>Icons>Icon")),A=f.querySelector(":scope>VideoClicks");let v=null,y=[];if(A){const e=A.querySelector(":scope>ClickThrough");e&&e.textContent&&(v={content:e.textContent});const t=A.querySelectorAll(":scope>ClickTracking");for(let e of t)e.textContent&&y.push({content:e.textContent})}return e.errorUrls=e.errorUrls.concat(s),e.impressionUrls.push(u),e.creatives.push({linear:{duration:h,mediaFiles:[],trackingEvents:E,clickThrough:v,clickTrackings:y,icons:g}}),e}updateInlineVastObject(e,r,a){let s=[];const c=r.querySelector(":scope>Error");c&&c.textContent&&s.push(c.textContent);const l=r.querySelector(":scope>Ad>InLine");if(!l)throw t(s,i.NoVASTResponseAfterWrapper,a),new Error("parse InLine error");const p=l.querySelector(":scope>Error");p&&p.textContent&&s.push(p.textContent);const d=l.querySelector(":scope>Impression");if(!d||!d.textContent)throw t(s,i.XMLParseError,a),new Error("parse InLine Impression error");const u=d.textContent,f=l.querySelector(":scope>AdTitle");if(!f||!f.textContent)throw t(s,i.XMLParseError,a),new Error("parse InLine AdTitle error");const T=f.textContent;let h=null;const m=l.querySelector(":scope>Description");m&&m.textContent&&(h=m.textContent);const E=l.querySelector(":scope>Creatives>Creative>Linear");if(!E)throw t(s,i.XMLParseError,a),new Error("parse InLine Linear error");const g=E.querySelector(":scope>Duration");if(!g||!g.textContent)throw t(s,i.XMLParseError,a),new Error("parse InLine Linear Duration error");const A=n(g.textContent),v=E.querySelectorAll(":scope>TrackingEvents>Tracking"),y=this.createTrackingObject(v,A),C=o(E.querySelectorAll(":scope>Icons>Icon")),I=E.querySelectorAll(":scope>MediaFiles>MediaFile");if(!I)throw t(s,i.XMLParseError,a),new Error("parse MediaFiles error");const x=I[0]?.textContent,S=E.querySelector(":scope>VideoClicks");let w=null,k=[];if(S){const e=S.querySelector(":scope>ClickThrough");if(!e||!e.textContent)throw t(s,i.XMLParseError,a),new Error("parse InLine Linear ClickThrough error");w={content:e.textContent};const r=S.querySelectorAll(":scope>ClickTracking");for(let e of r)e.textContent&&k.push({content:e.textContent})}return e.errorUrls=e.errorUrls.concat(s),e.impressionUrls.push(u),e.adTitle=T,e.adDesc=h,e.creatives.push({linear:{duration:A,mediaFiles:[{content:x}],trackingEvents:y,clickThrough:w,clickTrackings:k,icons:C}}),e}createTrackingObject(e,t){const r=new Map;return e.forEach((function(e){if(!e.textContent)return;const o=e.getAttribute("event");if(o)if("progress"===o){const t=e.getAttribute("offset");if(!t)return;const o=n(t);r.set(o,e.textContent)}else{const n=s.get(o);null!=n?r.set(n*t,e.textContent):r.set(o,e.textContent)}})),r}};const l=new class{async startPlayer(t){console.log("setPlayer started...");try{let o=document.createElement("iframe");o.width="300px",o.height="250px",o.style.border="none",document.getElementById("playerbox")?.appendChild(o);let i=o.contentWindow.document;i.open(),i.write('\n<!DOCTYPE html>\n<html>\n    <head>\n    </head>\n    <body style="margin:0;">\n        <div id="vast_video_container">\n            <div id="vast_video" style="width:300px;height:168.75px;"></div>\n            <div id="progress_bar" style="width:50%;height:3px;background-color:gray;"></div>\n            <div id="ad_text" style="margin:0;width:300px;height:78.25px;background-color:#dcdcdc;">\n                <div id="ad_title" style="font-size:15px;font-weight:bold;"></div>\n                <div id="ad_desc" style="font-size:10px;"></div>\n            </div>\n        </div>\n    </body>\n</html>\n'),i.close(),i.documentElement.style.overflow="hidden";let s=i.getElementById("vast_video");const l=a(s);'\n<VAST version="4.2">\n  <Error>\n    <![CDATA[http://test.example/error?code=[ERRORCODE]&clientTime=[TIMESTAMP]]]>\n  </Error>\n  <Ad id="1b330e59-3a62-4000-b9fb-ac9726e98c52" sequence="1">\n    <Wrapper>\n      <Impression><![CDATA[https://wrapper.test.example/impression?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Impression>\n      <VASTAdTagURI>\n        <![CDATA[http://localhost:8080/sample/inline.html]]>\n      </VASTAdTagURI>\n      <Creatives>\n        <Creative adId="7245" sequence="1">\n          <Linear>\n            <Duration>00:00:14.014</Duration>\n            <TrackingEvents>\n              <Tracking event="start"><![CDATA[https://wrapper.test.example/start?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n              <Tracking event="firstQuartile"><![CDATA[https://wrapper.test.example/firstQuartile?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n              <Tracking event="complete"><![CDATA[https://wrapper.test.example/complete?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n            </TrackingEvents>\n          </Linear>\n        </Creative>\n      </Creatives>\n    </Wrapper>\n  </Ad>\n</VAST>\n';const p=await c.parseVast('\n<VAST version="4.2">\n  <Error>\n    <![CDATA[http://test.example/error?code=[ERRORCODE]&clientTime=[TIMESTAMP]]]>\n  </Error>\n  <Ad id="1b330e59-3a62-4000-b9fb-ac9726e98c52" sequence="1">\n    <Wrapper>\n      <Impression><![CDATA[https://wrapper.test.example/impression?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Impression>\n      <VASTAdTagURI>\n        <![CDATA[http://localhost:8080/sample/inline.html]]>\n      </VASTAdTagURI>\n      <Creatives>\n        <Creative adId="7245" sequence="1">\n          <Linear>\n            <Duration>00:00:14.014</Duration>\n            <TrackingEvents>\n              <Tracking event="start"><![CDATA[https://wrapper.test.example/start?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n              <Tracking event="firstQuartile"><![CDATA[https://wrapper.test.example/firstQuartile?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n              <Tracking event="complete"><![CDATA[https://wrapper.test.example/complete?clientTime=[TIMESTAMP]&inview_ratio=[INVIEW_RATIO]]]></Tracking>\n            </TrackingEvents>\n          </Linear>\n        </Creative>\n      </Creatives>\n    </Wrapper>\n  </Ad>\n</VAST>\n',l);if(!p)return;i.getElementById("ad_title").textContent=p.adTitle;let d=i.getElementById("ad_desc");p.adDesc&&(d.textContent=p.adDesc);let u=document.createElement("video");for(let T of p.creatives)for(let h of T.linear.mediaFiles){let m=document.createElement("source");m.src=h.content;let E=(n=h.content,/\.mp4$/.test(n)?"video/mp4":/\.mov$/.test(n)?"video/quicktime":/\.mpg$/.test(n)||/\.mpeg$/.test(n)?"video/mpeg":/\.webm$/.test(n)?"video/webm":"");E&&(m.type=E),u.appendChild(m)}u.style.width="100%",u.style.height="100%",u.muted=!0,u.autoplay=!0,u.addEventListener("loadedmetadata",(function(e){let t=i.getElementById("progress_bar"),r=function(){let e=u.currentTime/u.duration*100;t.style.width=e+"%",requestAnimationFrame(r)};requestAnimationFrame(r)})),r(u,p,l),function(t,r,n,o){for(let i of n.creatives)for(let n of i.linear.icons){let i=document.createElement("img");i.src=n.imgUrl,i.width=n.width,i.height=n.height,i.style.position="fixed","left"===n.xPosition?i.style.left="0px":"right"===n.xPosition?i.style.right="0px":i.style.left=n.xPosition,"top"===n.yPosition?i.style.top="0px":"bottom"===n.yPosition?i.style.bottom="0px":i.style.top=n.yPosition,i.addEventListener("click",(function(r){n.clickTrackingUrl&&e(t,n.clickTrackingUrl,o),n.clickThroughUrl&&open(n.clickThroughUrl,"_blank")})),t.addEventListener("timeupdate",(function e(o){!r.contains(i)&&t.currentTime>=n.start&&r.appendChild(i),n.end&&r.contains(i)&&t.currentTime>=n.end&&(r.removeChild(i),t.removeEventListener("timeupdate",e))})),n.end||t.addEventListener("ended",(function(e){r.contains(i)&&r.removeChild(i)}))}}(u,s,p,l),s.appendChild(u);function f(e){e.forEach((function(e){e.isIntersecting?u.play():u.pause()}))}new IntersectionObserver(f,{rootMargin:"0px",threshold:.5}).observe(u)}catch(g){console.log("cannot start Player: "+g)}var n}};window.vastExecutor=window.vastExecutor||l}();
